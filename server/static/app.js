const _resizableCharts=[];let _globalResizeTimer=null;function withAlpha(e,t){if(e.startsWith("#")){const a=e.slice(1),n=parseInt(a,16);if(3===a.length){let e=n>>8&15;e|=e<<4;let a=n>>4&15;a|=a<<4;let s=15&n;return s|=s<<4,`rgba(${e},${a},${s},${t})`}return`rgba(${n>>16&255},${n>>8&255},${255&n},${t})`}const a=e.match(/[\d.]+/g);return a&&a.length>=3?`rgba(${a[0]},${a[1]},${a[2]},${t})`:e}window.addEventListener("resize",()=>{clearTimeout(_globalResizeTimer),_globalResizeTimer=setTimeout(()=>{_resizableCharts.forEach(e=>e.resize())},150)});class SparkChart{constructor(e,t={}){this.canvas=e,this.ctx=e.getContext("2d"),this.maxPoints=t.maxPoints||60,this.datasets=t.datasets||[{color:"#0a84ff",data:[]}],this.maxY=t.maxY||100,this.fixedMax=t.fixedMax,this.resize(),_resizableCharts.push(this)}resize(){const e=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=e.width*window.devicePixelRatio,this.canvas.height=e.height*window.devicePixelRatio,this.draw()}push(e){let t=!1;if(this.datasets.forEach((a,n)=>{const s=e[n]||0;a.data.push(s),a.data.length>this.maxPoints&&a.data.shift()>=.9*this.maxY&&(t=!0)}),!this.fixedMax)if(t){let e=0;for(const t of this.datasets)for(const a of t.data)a>e&&(e=a);e>.9*this.maxY?this.maxY=1.2*e:e<.5*this.maxY&&this.maxY>10&&(this.maxY=Math.max(10,.95*this.maxY))}else{const t=Math.max(...e);t>.9*this.maxY&&(this.maxY=1.2*t)}this.draw()}draw(){const{ctx:e,canvas:{width:t,height:a}}=this;e.clearRect(0,0,t,a),e.strokeStyle="rgba(128,128,128,0.1)",e.lineWidth=1,e.beginPath(),e.moveTo(0,.5*a),e.lineTo(t,.5*a),e.stroke(),this.datasets.forEach(n=>{if(n.data.length<2)return;const s=t/(this.maxPoints-1),o=n.data.map((e,t)=>({x:t*s,y:a-e/this.maxY*a}));e.beginPath(),e.moveTo(o[0].x,o[0].y);for(let t=0;t<o.length-1;t++){const a=o[Math.max(0,t-1)],n=o[t],s=o[t+1],r=o[Math.min(o.length-1,t+2)],l=n.x+(s.x-a.x)/6,i=n.y+(s.y-a.y)/6,c=s.x-(r.x-n.x)/6,d=s.y-(r.y-n.y)/6;e.bezierCurveTo(l,i,c,d,s.x,s.y)}e.strokeStyle=n.color,e.lineWidth=2*window.devicePixelRatio,e.stroke(),e.lineTo(o[o.length-1].x,a),e.lineTo(o[0].x,a),e.fillStyle=withAlpha(n.color,.06),e.fill()})}}class StoragePie{constructor(e,t,a){this.canvas=e,this.ctx=e.getContext("2d"),this.legend=t,this.tooltip=a,this.disks=[],this.hoverIdx=-1,this.slices=[],this._gradientsDirty=!0,this.refreshColors(),this.resize(),_resizableCharts.push(this),this.canvas.addEventListener("mousemove",e=>this.onMove(e)),this.canvas.addEventListener("touchmove",e=>{e.preventDefault(),this.onMove(e)},{passive:!1}),this.canvas.addEventListener("touchstart",e=>this.onMove(e),{passive:!0});const n=()=>{this.hoverIdx=-1,this.draw(),this.tooltip.style.opacity=0};this.canvas.addEventListener("mouseleave",n),this.canvas.addEventListener("touchend",n)}resize(){const e=this.canvas.parentElement.getBoundingClientRect();this.canvas.width=e.width*window.devicePixelRatio,this.canvas.height=e.height*window.devicePixelRatio,this._gradientsDirty=!0,this.draw()}refreshColors(){const e=getComputedStyle(document.documentElement);this.colors=[e.getPropertyValue("--accent").trim(),e.getPropertyValue("--purple").trim(),e.getPropertyValue("--cyan").trim(),e.getPropertyValue("--green").trim(),e.getPropertyValue("--yellow").trim(),e.getPropertyValue("--orange").trim()],this.freeColor=e.getPropertyValue("--surface3").trim(),this._cssSurface=e.getPropertyValue("--surface").trim(),this._cssText=e.getPropertyValue("--text").trim(),this._cssText2=e.getPropertyValue("--text2").trim()}update(e){e&&e.categories&&Array.isArray(e.categories)?(this.breakdown=e,this.useBreakdown=!0):(this.useBreakdown=!1,this.legacyDisks=e||[]),this.refreshColors(),this._gradientsDirty=!0,this.draw(),this.updateLegend()}draw(){const{ctx:e,canvas:t}=this,a=t.width,n=t.height,s=a/2,o=n/2,r=.38*Math.min(a,n),l=.28*r;e.clearRect(0,0,a,n);let i=0,c=[];if(this.useBreakdown&&this.breakdown)i=this.breakdown.total_gb||0,c=this.breakdown.categories||[];else{let e=0,t=0;(this.legacyDisks||[]).forEach(a=>{i=Math.max(i,a.total_gb),e+=a.used_gb,t=a.free_gb}),0===i&&(i=e+t),c=[{name:"Used",size_gb:e},{name:"Free Space",size_gb:t}]}if(e.beginPath(),e.arc(s,o,r,0,2*Math.PI),e.lineWidth=l,e.strokeStyle=this.freeColor,e.lineCap="butt",e.stroke(),0===i||0===c.length)return e.fillStyle=this._cssText2,e.font="500 12px -apple-system, BlinkMacSystemFont, sans-serif",e.textAlign="center",e.textBaseline="middle",void e.fillText("No Data",s,o);this.slices=[];let d=-Math.PI/2;const h=c.filter(e=>(e.size_gb||0)>0).length>1?.021:0,m=.5*h;let u=0;c.forEach((e,t)=>{const a="Free"===e.name||"Free Space"===e.name,n=e.size_gb||0;a||(u+=n);const s=n/i*Math.PI*2,o=Math.max(0,s-h);o>0&&this.slices.push({start:d+m,end:d+m+o,color:a?this.freeColor:this.colors[t%this.colors.length],data:e,type:a?"free":"used",idx:t}),d+=s}),e.save(),e.shadowColor="rgba(0,0,0,0.15)",e.shadowBlur=15,e.shadowOffsetY=5,e.beginPath(),e.arc(s,o,r,0,2*Math.PI),e.lineWidth=l,e.strokeStyle="transparent",e.stroke(),e.restore(),[...this.slices].sort((e,t)=>{const a=e.end-e.start;return t.end-t.start-a}).forEach(t=>{const a=t.idx===this.hoverIdx,n=a?4:0,i=(t.start+t.end)/2,c=Math.cos(i)*n,d=Math.sin(i)*n;e.beginPath(),e.arc(s+c,o+d,r+(a?2:0),t.start,t.end),e.lineWidth=l+(a?2:0),e.lineCap="butt";const h=e.createLinearGradient(s+Math.cos(t.start)*(r-l),o+Math.sin(t.start)*(r-l),s+Math.cos(t.end)*(r+l),o+Math.sin(t.end)*(r+l));"free"===t.type?(h.addColorStop(0,this.freeColor),h.addColorStop(1,this.adjustColor(this.freeColor,-10))):(h.addColorStop(0,this.adjustColor(t.color,25)),h.addColorStop(.5,t.color),h.addColorStop(1,this.adjustColor(t.color,-15))),e.strokeStyle=h,e.stroke(),"free"!==t.type&&(e.beginPath(),e.arc(s+c,o+d,r-.35*l,t.start,t.end),e.lineWidth=1.5,e.lineCap="butt",e.strokeStyle="rgba(255,255,255,0.3)",e.stroke())});const p=Math.round(u/i*100);e.beginPath(),e.arc(s,o,r-l-8,0,2*Math.PI),e.fillStyle=this._cssSurface,e.fill(),e.fillStyle=this._cssText,e.font="700 22px -apple-system, BlinkMacSystemFont, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(`${p}%`,s,o-2),e.fillStyle=this._cssText2,e.font="500 10px -apple-system, BlinkMacSystemFont, sans-serif",e.fillText("Used",s,o+14)}onMove(e){const t=this.canvas.getBoundingClientRect(),a=e.touches&&e.touches.length>0?e.touches[0].clientX:e.clientX,n=e.touches&&e.touches.length>0?e.touches[0].clientY:e.clientY,s=(a-t.left)*window.devicePixelRatio,o=(n-t.top)*window.devicePixelRatio,r=this.canvas.width,l=this.canvas.height,i=r/2,c=l/2,d=.38*Math.min(r,l),h=.28*d,m=s-i,u=o-c,p=Math.sqrt(m*m+u*u);let g=-1;if(p>=d-h/2-5&&p<=d+h/2+5){let e=Math.atan2(u,m);e<-Math.PI/2&&(e+=2*Math.PI);for(let t=0;t<this.slices.length;t++){const a=this.slices[t];let n=e;if(n<a.start&&n+2*Math.PI>a.start&&(n+=2*Math.PI),n>=a.start&&n<=a.end){g=a.idx;break}}}if(this.hoverIdx!==g)if(this.hoverIdx=g,this.draw(),-1!==this.hoverIdx){const e=this.slices[this.hoverIdx],t=this.tooltip;t.style.opacity=1;const s=this.canvas.parentElement.parentElement.getBoundingClientRect();let o=a-s.left+12,r=n-s.top+12;t.style.left=o+"px",t.style.top=r+"px";const l=this.useBreakdown&&this.breakdown.total_gb||0,i=l>0?Math.round(e.data.size_gb/l*100):0,c=e.data.size_gb>=1e3?`${(e.data.size_gb/1e3).toFixed(2)} TB`:`${e.data.size_gb.toFixed(1)} GB`;t.textContent="";const d=document.createElement("div");d.className="tip-title",d.textContent=e.data.name,t.appendChild(d);const h=document.createElement("div");h.className="tip-detail";const m=document.createElement("span");m.className="tip-value",m.textContent=c,h.appendChild(m),h.appendChild(document.createTextNode(" "));const u=document.createElement("span");u.className="tip-pct",u.textContent=`(${i}%)`,h.appendChild(u),t.appendChild(h)}else this.tooltip.style.opacity=0}_addHeader(e){const t=document.createElement("div");t.className="legend-header",t.textContent=e,this.legend.appendChild(t)}_fmtSize(e){return e>=1e3?`${(e/1e3).toFixed(2)} TB`:`${e.toFixed(1)} GB`}updateLegend(){this.legend.innerHTML="";let e=0,t=[];if(this.useBreakdown&&this.breakdown){e=this.breakdown.total_gb||0,t=this.breakdown.categories||[];const a=this.breakdown.purgeable_gb||0;this._addHeader(`Storage â€¢ ${this._fmtSize(e)} Total`),t.forEach((t,n)=>{const s="Free"===t.name||"Free Space"===t.name,o=Math.round(t.size_gb/e*100);this.addLegendItem(s?this.freeColor:this.colors[n%this.colors.length],t.name,`${this._fmtSize(t.size_gb)} (${o}%)`),s&&a>.5&&this._addPurgeableNote(a)})}else{let t=0,a=0;(this.legacyDisks||[]).forEach(n=>{e=Math.max(e,n.total_gb),t+=n.used_gb,a=n.free_gb}),this._addHeader(`${this.legacyDisks.length} Volume${1!==this.legacyDisks.length?"s":""} â€¢ ${e.toFixed(0)} GB`),this.legacyDisks.forEach((e,t)=>{const a="/"===e.mount_point?"Macintosh HD":e.mount_point.replace("/Volumes/","");this.addLegendItem(this.colors[t%this.colors.length],a,`${e.used_gb} GB (${Math.round(e.used_gb/e.total_gb*100)}%)`)}),a>0&&this.addLegendItem(this.freeColor,"Available",`${a.toFixed(0)} GB (${Math.round(a/e*100)}%)`)}}_addPurgeableNote(e){const t=document.createElement("div");t.className="legend-purgeable-note",t.textContent=`â†³ incl. ${this._fmtSize(e)} purgeable`,this.legend.appendChild(t)}addLegendItem(e,t,a){const n=document.createElement("div");n.className="legend-row";const s=document.createElement("div");s.className="legend-dot",s.style.background=e;const o=document.createElement("div");o.className="legend-text";const r=document.createElement("div");r.className="legend-name-row";const l=document.createElement("span");l.className="legend-name",l.textContent=t;const i=document.createElement("span");i.className="legend-size",i.textContent=a,r.appendChild(l),r.appendChild(i),o.appendChild(r),n.appendChild(s),n.appendChild(o),this.legend.appendChild(n)}adjustColor(e,t){let a,n,s;if(e.startsWith("#")){const t=e.slice(1),o=parseInt(t,16);3===t.length?(a=o>>8&15,a|=a<<4,n=o>>4&15,n|=n<<4,s=15&o,s|=s<<4):(a=o>>16&255,n=o>>8&255,s=255&o)}else{if(!e.startsWith("rgb"))return e;{const t=e.match(/\d+/g);if(!t)return e;a=parseInt(t[0]),n=parseInt(t[1]),s=parseInt(t[2])}}return a=Math.max(0,Math.min(255,a+t)),n=Math.max(0,Math.min(255,n+t)),s=Math.max(0,Math.min(255,s+t)),`rgb(${a},${n},${s})`}}const charts={cpu:new SparkChart(document.getElementById("cpuChart"),{fixedMax:!0}),mem:new SparkChart(document.getElementById("memChart"),{fixedMax:!0,datasets:[{color:"#bf5af2",data:[]}]}),net:new SparkChart(document.getElementById("netChart"),{maxY:1024,datasets:[{color:"#30d158",data:[]},{color:"#ff453a",data:[]}]}),disk:new SparkChart(document.getElementById("diskChart"),{maxY:10,datasets:[{color:"#30d158",data:[]},{color:"#ff9f0a",data:[]}]}),gpu:new SparkChart(document.getElementById("gpuChart"),{fixedMax:!0,datasets:[{color:"#64d2ff",data:[]}]}),health:new SparkChart(document.getElementById("healthSparkline"),{maxPoints:30,maxY:10,datasets:[{color:"#ff453a",data:[]}]}),storage:new StoragePie(document.getElementById("storagePie"),document.getElementById("storageLegend"),document.getElementById("storageTooltip"))};let lastData=null,procSort={key:"cpu",dir:-1},wsRef=null,wsReconnectDelay=2e3;function connect(){const e=new WebSocket(("https:"===location.protocol?"wss:":"ws:")+"//"+location.host+"/ws");wsRef=e,e.onopen=()=>{wsReconnectDelay=2e3,document.getElementById("connDot").className="conn-dot connected",document.getElementById("connText").textContent="Live";const t=localStorage.getItem("talaria-rate");t&&(document.getElementById("rateSelect").value=t,e.send(JSON.stringify({action:"set_rate",rate:parseInt(t)})))},fetch("/api/config").then(e=>e.json()).then(e=>{e&&e.theme&&(localStorage.setItem("talaria-theme",e.theme),applyTheme(e.theme))}).catch(e=>console.log("Config load failed",e)),e.onclose=()=>{wsRef=null,document.getElementById("connDot").className="conn-dot",document.getElementById("connText").textContent="Reconnecting...",setTimeout(connect,wsReconnectDelay),wsReconnectDelay=Math.min(2*wsReconnectDelay,3e4)},e.onmessage=e=>{try{update(JSON.parse(e.data))}catch(e){console.error("Malformed WS payload",e)}}}function setVal(e,t){const a=document.getElementById(e);a&&a.textContent!==String(t)&&(a.textContent=t)}function setStyle(e,t,a){const n=document.getElementById(e);n&&n.style[t]!==a&&(n.style[t]=a)}function setGauge(e,t,a){const n=document.getElementById(e);n.style.strokeDashoffset=263.9-t/100*263.9,a?n.style.stroke=a:n.style.removeProperty("stroke")}function formatSpeed(e,t,a){e>1048576?(setVal(t,(e/1048576).toFixed(1)),setVal(a,"MB/s")):(setVal(t,(e/1024).toFixed(1)),setVal(a,"KB/s"))}function flash(e){const t=document.getElementById(e);t.classList.remove("flash-alert"),t.offsetWidth,t.classList.add("flash-alert")}function updateHeader(e){setVal("chipHostname",e.system.hostname),setVal("chipOS",e.system.os_version),setVal("chipUptime","up "+e.system.uptime),setVal("connCount","("+e.client_count+")")}function updateCPU(e){const t=e.cpu.usage_percent;if(setVal("cpuValue",t.toFixed(1)+"%"),setVal("cpuPct",Math.round(t)+"%"),setVal("cpuCores",e.cpu.core_count+" cores"),setVal("cpuModel",e.cpu.model),setGauge("cpuGauge",t),charts.cpu.push([t]),t>90&&flash("cardCPU"),e.cpu.per_core&&e.cpu.per_core.length>0){const t=document.getElementById("coreGrid");t.childElementCount!==e.cpu.per_core.length&&(t.innerHTML="",e.cpu.per_core.forEach((e,a)=>{const n=document.createElement("div");n.className="core-bar-wrap";const s=document.createElement("div");s.className="core-bar-track";const o=document.createElement("div");o.className="core-bar-fill",s.appendChild(o),n.appendChild(s),t.appendChild(n)})),e.cpu.per_core.forEach((e,a)=>{const n=t.children[a];if(!n)return;n.title="Core "+a+": "+e.toFixed(1)+"%";const s=n.firstChild.firstChild;s.style.width=Math.min(100,e)+"%",s.style.background=e>80?"var(--red)":e>50?"var(--yellow)":"var(--accent)"})}e.system.load_avg&&setVal("loadAvg","Load: "+e.system.load_avg)}function updateMemory(e){const t=e.memory.used_percent;setVal("memPct",Math.round(t)+"%"),setVal("memUsedVal",(e.memory.used_mb/1024).toFixed(1)),setVal("memTotal",`of ${(e.memory.total_mb/1024).toFixed(1)} GB`),setVal("memSwap",`Swap: ${Math.round(e.memory.swap_used_mb)} MB`),setVal("memPressure","Pressure: "+e.memory.pressure_level),setGauge("memGauge",t,"Critical"===e.memory.pressure_level?"var(--red)":null),charts.mem.push([t]),"Critical"===e.memory.pressure_level&&flash("cardMem");const a=e.memory.total_mb||1,n=(e.memory.wired_mb||0)+(e.memory.active_mb||0)+(e.memory.compressed_mb||0)+(e.memory.inactive_mb||0),s=n>0?Math.min(1,a/n):1;setStyle("memBarWired","width",e.memory.wired_mb/a*100*s+"%"),setStyle("memBarActive","width",e.memory.active_mb/a*100*s+"%"),setStyle("memBarCompressed","width",e.memory.compressed_mb/a*100*s+"%"),setStyle("memBarInactive","width",e.memory.inactive_mb/a*100*s+"%"),setVal("memLblWired","Wired: "+(e.memory.wired_mb/1024).toFixed(1)+"G"),setVal("memLblActive","Active: "+(e.memory.active_mb/1024).toFixed(1)+"G"),setVal("memLblCompressed","Compressed: "+(e.memory.compressed_mb/1024).toFixed(1)+"G")}function updateGPU(e){if(!e.gpu)return;const t=e.gpu.utilization;setVal("gpuValue",t+"%"),setVal("gpuPct",t+"%"),setVal("gpuModel",e.gpu.model||"--"),setVal("gpuCores",e.gpu.core_count+" cores"),setVal("gpuVRAM","VRAM: "+e.gpu.vram_used_mb+" / "+e.gpu.vram_alloc_mb+" MB"),setGauge("gpuGauge",t),charts.gpu.push([t]),t>90&&flash("cardGPU")}function updateDiskIO(e){setVal("diskReadVal",e.disk_io.read_mbps.toFixed(1)),setVal("diskWriteVal",e.disk_io.write_mbps.toFixed(1)),setVal("diskTotal",`R: ${(e.disk_io.read_mb/1024).toFixed(0)}G  W: ${(e.disk_io.write_mb/1024).toFixed(0)}G`),charts.disk.push([e.disk_io.read_mbps,e.disk_io.write_mbps])}function updateNetwork(e){formatSpeed(e.network.bytes_in_rate,"netInVal","netInUnit"),formatSpeed(e.network.bytes_out_rate,"netOutVal","netOutUnit"),charts.net.push([e.network.bytes_in_rate/1024,e.network.bytes_out_rate/1024]),setVal("netIP",e.network.local_ip||"No IP"),setVal("netPublicIP",e.network.public_ip||"Hidden");const t=e.network.connection_type||"Unknown";"Wi-Fi"===t&&e.network.wifi_ssid?setVal("netSSID",t+" â€¢ "+e.network.wifi_ssid):setVal("netSSID",t)}function updateSecurity(e){e.security&&(setVal("secLock",e.security.screen_locked?"Locked":"Unlocked"),document.getElementById("secLock").className=e.security.screen_locked?"card-badge good":"card-badge warn",setVal("secUserCount",(e.security.user_sessions?e.security.user_sessions.length:0)+" Sessions"),setVal("secUsers",e.security.user_sessions?e.security.user_sessions.map(e=>e.user+" ("+e.terminal+")").join(", "):"None"),setVal("secWake",e.security.wake_history?e.security.wake_history.slice(0,3).join("\n"):"--"))}function updateConnectivity(e){if(!e.connectivity)return;setVal("connVPN",e.connectivity.vpn_active?"VPN Active":"No VPN"),document.getElementById("connVPN").className=e.connectivity.vpn_active?"card-badge good":"card-badge",setVal("connEst",e.connectivity.active_connections),setVal("connListen",e.connectivity.listening_ports);const t=document.getElementById("connBT"),a=e.connectivity.bluetooth_devices;if(a&&0!==a.length){for(0===t.childElementCount&&t.firstChild&&(t.textContent="");t.childElementCount<a.length;)t.appendChild(document.createElement("div"));for(;t.childElementCount>a.length;)t.lastChild.remove();a.forEach((e,a)=>{const n=e.name+(e.battery?" ("+e.battery+")":"");t.children[a].textContent!==n&&(t.children[a].textContent=n)})}else(t.childElementCount>0||"No devices"!==t.textContent)&&(t.textContent="No devices")}function updateHealth(e){if(!e.health)return;const t=e.health,a=t.health_score;setVal("healthScoreVal",a),setGauge("healthGauge",a,a>80?"var(--green)":a>50?"var(--yellow)":"var(--red)");const n=document.getElementById("healthErrors");setVal("healthErrors","Score: "+a),n.className=a>90?"card-badge good":a>70?"card-badge warn":"card-badge crit";const s=document.getElementById("checkSIP"),o=document.getElementById("checkFV"),r=document.getElementById("checkFW"),l=document.getElementById("checkKernel");s.querySelector(".check-label").textContent="SIP: "+(t.sip_enabled?"On":"Off"),s.className="health-check-item "+(t.sip_enabled?"good":"bad"),o.querySelector(".check-label").textContent="Encrypt: "+(t.filevault_enabled?"On":"Off"),o.className="health-check-item "+(t.filevault_enabled?"good":"bad"),r.querySelector(".check-label").textContent="Firewall: "+(t.firewall_enabled?"On":"Off"),r.className="health-check-item "+(t.firewall_enabled?"good":"warn");const i=t.kernel_errors_last_5m||0;if(l.querySelector(".check-label").textContent="Kernel: "+(0===i?"Stable":i+" Err"),l.className="health-check-item "+(0===i?"good":"bad interactive"),i>0?(l.classList.add("interactive"),l.title="View kernel logs"):(l.classList.remove("interactive"),l.removeAttribute("title")),t.error_history&&t.error_history.length>0){const e=charts.health,a=Math.max(...t.error_history,1);e.maxY=1.5*a;const n=e.datasets[0].data;n.length=0;for(let e=0;e<t.error_history.length;e++)n.push(t.error_history[e]);e.datasets[0].color=a>0?"#ff453a":"#30d158",e.draw()}else charts.health.push([i]);const c=document.getElementById("tmStatusPill");c.textContent=t.tm_status,c.className="tm-status-pill "+(t.tm_status||"").toLowerCase(),setVal("tmBackup","Last: "+(t.tm_last_backup||"Never")),setVal("tmAge",t.tm_age_label||"");const d=document.getElementById("tmAge");t.tm_age_mins>1440?d.style.color="var(--red)":t.tm_age_mins>360?d.style.color="var(--yellow)":d.style.color="var(--text2)";const h=document.getElementById("tmProgressWrap");"Running"===t.tm_status&&t.tm_percent>=0?(h.style.display="flex",setStyle("tmProgressFill","width",Math.min(100,t.tm_percent)+"%"),setVal("tmProgressLabel",t.tm_percent.toFixed(1)+"%")):h.style.display="none",t.kernel_errors_last_5m>50&&flash("cardHealth")}let _lastClockSec=-1;function updateCalendar(e){if(!e.system.current_date)return;const t=e.system.current_date.split(", ");if(2===t.length){const e=t[0].substring(0,3),a=t[1].split(" ");setVal("calMonth",a[1]+" "+a[2]),setVal("calNum",a[0]),setVal("calDay",e)}setVal("digitalTime",e.system.current_time);const a=new Date(e.timestamp).getSeconds();a!==_lastClockSec&&(_lastClockSec=a,drawAnalogClock(e.timestamp))}function updateStatus(e){setVal("thermalState",e.thermal.thermal_state);const t=e.thermal.thermal_state;if(setStyle("thermalState","color","Serious"===t||"Critical"===t?"var(--red)":"var(--text)"),e.battery.has_battery){setVal("batPct",e.battery.percent+"%"),setVal("batStatus",e.battery.charging?"Charging":e.battery.time_left||"On Battery");const t=e.battery.health_percent,a=t>80?"var(--green)":t>60?"var(--yellow)":"var(--red)",n=document.getElementById("batHealthVal");n.textContent=t.toFixed(1)+"%",n.style.color=a,setVal("batCycles","Cycles: "+e.battery.cycle_count),setVal("batTemp","Temp: "+e.battery.temperature.toFixed(1)+"Â°C")}else setVal("batPct","AC"),setVal("batStatus","Desktop")}function updateStorage(e){e.storage_breakdown&&e.storage_breakdown.categories?charts.storage.update(e.storage_breakdown):charts.storage.update(e.disks)}let _lastAlertCheck=0;function update(e){lastData=e,updateHeader(e),updateCPU(e),updateMemory(e),updateGPU(e),updateDiskIO(e),updateNetwork(e),updateSecurity(e),updateConnectivity(e),updateHealth(e),updateCalendar(e),updateStatus(e),updateStorage(e),renderProcesses();const t=performance.now();t-_lastAlertCheck>5e3&&(checkAlerts(e),_lastAlertCheck=t),updateFavicon(e.cpu.usage_percent)}class ProcessTable{constructor(e){this.tbody=document.getElementById(e),this.rows=[],this.poolSize=0}_makeBarCell(e){const t=document.createElement("td"),a=document.createElement("div");a.className="proc-bar-wrap";const n=document.createElement("div");n.className="bar-bg";const s=document.createElement("div");s.className="bar-fill",s.style.backgroundColor=e,n.appendChild(s);const o=document.createElement("span");return o.className="proc-bar-txt",a.appendChild(n),a.appendChild(o),t.appendChild(a),t}update(e){if(!e)return void console.warn("ProcessTable: procs is null");if(0===e.length)return this.tbody.innerHTML='<tr><td colspan="6" class="conn-loading">No processes found</td></tr>',this.rows=[],void(this.poolSize=0);0===this.poolSize&&this.tbody.childElementCount>0&&(this.tbody.innerHTML="");const t=e.length;for(;this.poolSize<t;){const e=document.createElement("tr"),t=document.createElement("td");t.className="conn-cell-name",e.appendChild(t);const a=document.createElement("td");a.className="conn-cell-dim",e.appendChild(a),e.appendChild(this._makeBarCell("var(--accent)")),e.appendChild(this._makeBarCell("var(--purple)"));const n=document.createElement("td");n.className="conn-cell-dim",e.appendChild(n);const s=document.createElement("td");s.style.textAlign="center";const o=document.createElement("button");o.className="btn btn-danger conn-kill",o.textContent="Kill",o.onclick=e=>killProc(parseInt(e.currentTarget.dataset.pid)),s.appendChild(o),e.appendChild(s),this.tbody.appendChild(e),this.rows.push(e),this.poolSize++}for(let e=t;e<this.poolSize;e++)this.rows[e].style.display="none";for(let a=0;a<t;a++){const t=e[a],n=this.rows[a],s=n.children;n.style.display="";const o=(e,t)=>{e.textContent!==t&&(e.textContent=t)};o(s[0],t.name),o(s[1],String(t.pid));const r=s[2].firstChild.firstChild.firstChild,l=s[2].firstChild.lastChild,i=Math.min(100,t.cpu)+"%";r.style.width!==i&&(r.style.width=i),o(l,t.cpu.toFixed(1)+"%");const c=s[3].firstChild.firstChild.firstChild,d=s[3].firstChild.lastChild,h=Math.min(100,2*t.mem_percent)+"%";c.style.width!==h&&(c.style.width=h),o(d,Math.round(t.mem_mb)+" MB"),o(s[4],t.user),s[5].firstChild.dataset.pid=t.pid}}}const procTable=new ProcessTable("procBody");function renderProcesses(){if(!lastData||!lastData.processes)return;let e=lastData.processes;const t=document.getElementById("procSearch").value.toLowerCase();t&&(e=e.filter(e=>e.name&&e.name.toLowerCase().includes(t)||String(e.pid).includes(t)||e.user&&e.user.toLowerCase().includes(t))),e.sort((e,t)=>{let a=e[procSort.key],n=t[procSort.key];return"string"==typeof a&&(a=a.toLowerCase(),n=n.toLowerCase()),a<n?-procSort.dir:a>n?procSort.dir:e.pid-t.pid}),procTable.update(e)}function sortProcs(e){procSort.key===e?procSort.dir*=-1:(procSort.key=e,procSort.dir=-1),renderProcesses()}async function killProc(e){if(confirm(`Are you sure you want to kill process ${e}?`))try{const t=await fetch(`/api/kill?pid=${e}`,{method:"POST"});t.ok?showToast("kill-"+Date.now(),"Process killed","info"):showToast("kill-err-"+Date.now(),"Failed: "+await t.text(),"warn")}catch(e){showToast("kill-ex-"+Date.now(),"Error: "+e,"crit")}}async function flushDNS(){try{const e=await fetch("/api/flushdns",{method:"POST",headers:{"X-CSRF-Token":getCsrfToken()}});e.ok?showToast("dns-"+Date.now(),"DNS cache flushed","info"):showToast("dns-err-"+Date.now(),"Failed: "+await e.text(),"warn")}catch(e){showToast("dns-ex-"+Date.now(),"Error: "+e,"crit")}}function exportMetrics(){window.open("/api/export","_blank")}function getTheme(){return localStorage.getItem("talaria-theme")||"dark"}function applyTheme(e){document.documentElement.setAttribute("data-theme",e),document.getElementById("themeToggle").textContent="dark"===e?"â˜€":"â˜¾"}function toggleTheme(){const e="dark"===getTheme()?"light":"dark";localStorage.setItem("talaria-theme",e),applyTheme(e)}function setRate(e){e=parseInt(e),localStorage.setItem("talaria-rate",e),wsRef&&wsRef.readyState===WebSocket.OPEN&&wsRef.send(JSON.stringify({action:"set_rate",rate:e}))}document.addEventListener("keydown",e=>{const t=document.activeElement,a="INPUT"===t.tagName||"TEXTAREA"===t.tagName;if(!document.getElementById("termModal").classList.contains("show"))return"Escape"===e.key?(document.getElementById("procSearch").blur(),document.getElementById("procSearch").value="",renderProcesses(),closeConnModal(),void closeHealthModal()):void(a||("p"===e.key&&(e.preventDefault(),document.getElementById("procSearch").focus()),"t"===e.key&&(e.preventDefault(),toggleTheme())))}),applyTheme(getTheme());const toastShown={};function showToast(e,t,a){if(toastShown[e])return;toastShown[e]=!0;const n=document.getElementById("toastContainer"),s=document.createElement("div");s.className="toast "+("crit"===a?"toast-crit":"toast-warn");const o=document.createElement("div");o.className="toast-icon";const r="crit"===a?"tplCritIcon":"tplWarnIcon",l=document.getElementById(r);l&&o.appendChild(l.content.cloneNode(!0));const i=document.createElement("div");i.className="toast-body";const c=document.createElement("div");c.className="toast-title",c.textContent=t,i.appendChild(c);const d=document.createElement("button");d.className="toast-dismiss";const h=document.getElementById("tplDismissIcon");for(h&&d.appendChild(h.content.cloneNode(!0)),d.onclick=e=>{e.stopPropagation(),dismissToast(s)},s.appendChild(o),s.appendChild(i),s.appendChild(d),s.onclick=()=>dismissToast(s),n.appendChild(s),setTimeout(()=>dismissToast(s),5e3);n.children.length>4;)n.firstChild.remove()}function dismissToast(e){e.classList.contains("toast-out")||(e.classList.add("toast-out"),setTimeout(()=>e.remove(),350))}function checkAlerts(e){e.cpu.usage_percent>90&&showToast("cpu-high","CPU usage at "+e.cpu.usage_percent.toFixed(1)+"%","warn"),"Critical"===e.memory.pressure_level&&showToast("mem-crit","Memory pressure is Critical","crit"),"Warn"===e.memory.pressure_level&&showToast("mem-warn","Memory pressure is elevated","warn"),"Critical"===e.thermal.thermal_state&&showToast("thermal-crit","Thermal state: Critical","crit"),"Serious"===e.thermal.thermal_state&&showToast("thermal-serious","Thermal state: Serious","warn"),e.disks&&e.disks.forEach(e=>{const t=e.mount_point||"";t.includes("CoreSimulator")||t.includes("Cryptex")||t.includes("TimeMachine")||t.includes(".timemachine")||t.startsWith("/System/Volumes/VM")||t.startsWith("/System/Volumes/Preboot")||t.startsWith("/System/Volumes/Recovery")||t.startsWith("/System/Volumes/Update")||t.startsWith("/private/var/folders/")||t.startsWith("/Library/Developer/CoreSimulator/")||t.startsWith("/Library/Developer/XCTestDevices/")||e.used_percent>95&&showToast("disk-"+t,"Disk "+t+" at "+Math.round(e.used_percent)+"%","warn")}),e.battery.has_battery&&e.battery.percent<=10&&!e.battery.charging&&showToast("bat-low","Battery critically low: "+e.battery.percent+"%","crit"),e.security&&e.security.ssh_active&&!toastShown["sec-ssh"]&&showToast("sec-ssh","Active remote session detected","warn"),e.health&&e.health.health_score<40&&!toastShown["health-err"]&&showToast("health-err","System health score is low ("+e.health.health_score+")","warn"),e.health&&"rising"===e.health.error_trend&&!toastShown["health-trend"]&&showToast("health-trend","System error rate is rising","warn")}function openHealthLogs(){if(0===(lastData&&lastData.health&&lastData.health.kernel_errors_last_5m||0))return;const e=document.getElementById("healthLogContent");lastData.health.kernel_logs&&0!==lastData.health.kernel_logs.length?(e.textContent=lastData.health.kernel_logs.join("\n"),e.style.color="var(--text)"):(e.textContent="No critical kernel errors detected in the last 5 minutes.",e.style.color="var(--green)"),document.getElementById("healthModal").classList.add("show")}function closeHealthModal(){document.getElementById("healthModal").classList.remove("show")}document.getElementById("checkKernel").addEventListener("click",openHealthLogs);const faviconCanvas=document.createElement("canvas");faviconCanvas.width=32,faviconCanvas.height=32;const faviconCtx=faviconCanvas.getContext("2d",{willReadFrequently:!0});let faviconLink=document.querySelector('link[rel="icon"]'),_prevFaviconBlobURL=null,_prevFaviconPct=-1,_faviconLastUpdate=0;function updateFavicon(e){const t=performance.now(),a=Math.round(e);if(a===_prevFaviconPct&&t-_faviconLastUpdate<2e3)return;_prevFaviconPct=a,_faviconLastUpdate=t;const n=faviconCtx;n.clearRect(0,0,32,32),n.beginPath(),n.arc(16,16,13,0,2*Math.PI),n.strokeStyle="rgba(150,150,150,0.3)",n.lineWidth=4,n.stroke();const s=-Math.PI/2,o=s+e/100*Math.PI*2;n.beginPath(),n.arc(16,16,13,s,o),n.strokeStyle=e>80?"#ff453a":e>50?"#ffd60a":"#30d158",n.lineWidth=4,n.lineCap="round",n.stroke(),n.fillStyle="#ffffff",n.font="bold 11px sans-serif",n.textAlign="center",n.textBaseline="middle",n.fillText(a,16,17),faviconCanvas.toBlob(function(e){_prevFaviconBlobURL&&URL.revokeObjectURL(_prevFaviconBlobURL),_prevFaviconBlobURL=URL.createObjectURL(e),faviconLink.href=_prevFaviconBlobURL},"image/png")}let connData=null,currentConnTab="active";function openConnModal(e){document.getElementById("connModal").classList.add("show"),switchConnTab(e),fetchConnections()}function closeConnModal(){document.getElementById("connModal").classList.remove("show")}const _connHeaders={active:(()=>{const e=document.createElement("tr");return["Process","PID","Remote Address","State","Action"].forEach((t,a)=>{const n=document.createElement("th");n.textContent=t,4===a&&(n.style.width="60px"),e.appendChild(n)}),e})(),listen:(()=>{const e=document.createElement("tr");return["Process","PID","Local Address","Protocol","Action"].forEach((t,a)=>{const n=document.createElement("th");n.textContent=t,4===a&&(n.style.width="60px"),e.appendChild(n)}),e})()};function switchConnTab(e){currentConnTab=e,document.getElementById("tabActive").className="active"===e?"modal-tab active":"modal-tab",document.getElementById("tabListen").className="listen"===e?"modal-tab active":"modal-tab";const t=document.getElementById("connHead");t.innerHTML="",t.appendChild(_connHeaders[e].cloneNode(!0)),renderConnTable()}async function fetchConnections(){try{const e=await fetch("/api/connections");e.ok?(connData=await e.json(),connData.active&&setVal("connEst",connData.active.length),connData.listening&&setVal("connListen",connData.listening.length),renderConnTable()):showToast("conn-err-"+Date.now(),"Failed to load connections: "+e.status,"warn")}catch(e){console.error(e),showToast("conn-ex-"+Date.now(),"Network error loading connections","crit")}}function renderConnTable(){const e=document.getElementById("connBody");if(!connData)return;let t="active"===currentConnTab?connData.active:connData.listening;const a=document.getElementById("connSearch").value.toLowerCase();if(a&&(t=t.filter(e=>e.process&&e.process.toLowerCase().includes(a)||String(e.pid).includes(a)||e.remote&&e.remote.toLowerCase().includes(a)||e.local&&e.local.toLowerCase().includes(a)||e.state&&e.state.toLowerCase().includes(a)||e.protocol&&e.protocol.toLowerCase().includes(a))),!t||0===t.length){for(;e.firstChild;)e.removeChild(e.firstChild);const t=document.createElement("tr"),a=document.createElement("td");return a.colSpan=5,a.style.cssText="text-align:center;padding:20px;color:var(--text3)",a.textContent="No connections found",t.appendChild(a),void e.appendChild(t)}const n=e.children,s="active"===currentConnTab;for(let a=0;a<t.length;a++){const o=t[a];let r;if(a<n.length)for(r=n[a],r.cells[0]&&r.cells[0].hasAttribute("colspan")&&r.cells[0].removeAttribute("colspan");r.children.length<5;)r.appendChild(document.createElement("td"));else{r=document.createElement("tr");for(let e=0;e<5;e++)r.appendChild(document.createElement("td"));e.appendChild(r)}const l=r.children;l[0].textContent=o.process||"",l[0].className="conn-cell-name",l[1].textContent=o.pid||"",l[1].className="conn-cell-dim",l[2].textContent=s?o.remote||"":o.local||"",l[2].className="conn-cell-addr";const i=s?o.state||"":o.protocol||"";if(l[3].firstChild&&1===l[3].firstChild.nodeType&&"sys-info-chip"===l[3].firstChild.className)l[3].firstChild.textContent=i;else{l[3].textContent="";const e=document.createElement("span");e.className="sys-info-chip",e.textContent=i,l[3].appendChild(e)}if(!l[4].firstChild||"BUTTON"!==l[4].firstChild.tagName){l[4].textContent="";const e=document.createElement("button");e.className="btn btn-danger conn-kill",e.textContent="Kill",l[4].appendChild(e)}l[4].firstChild.onclick=()=>killProc(o.pid)}for(;e.children.length>t.length;)e.removeChild(e.lastChild)}function drawAnalogClock(e){const t=document.getElementById("analogClock");if(!t)return;const a=t.getContext("2d"),n=new Date(e),s=t.width,o=t.height,r=s/2,l=o/2,i=s/2-2;a.clearRect(0,0,s,o);const c="dark"===getTheme();a.beginPath(),a.arc(r,l,i,0,2*Math.PI),a.fillStyle=c?"#2c2c2e":"#ffffff",a.fill();const d=c?"rgba(255,255,255,0.6)":"#1d1d1f",h=c?"rgba(255,255,255,0.2)":"rgba(0,0,0,0.15)";for(let e=0;e<60;e++){const t=e%5==0,n=6*e*Math.PI/180,s=t?10:6,o=t?3:1.5;a.beginPath(),a.lineCap="round",a.lineWidth=o,a.strokeStyle=t?d:h;const c=i-4,m=c-s;a.moveTo(r+c*Math.cos(n),l+c*Math.sin(n)),a.lineTo(r+m*Math.cos(n),l+m*Math.sin(n)),a.stroke()}const m=n.getHours(),u=n.getMinutes(),p=n.getSeconds(),g=c?"#ffffff":"#000000",f="#ff9f0a";drawHand(a,r,l,30*(m%12+u/60)*Math.PI/180-Math.PI/2,.55*i,5,g,!0),drawHand(a,r,l,6*(u+p/60)*Math.PI/180-Math.PI/2,.9*i,3.5,g,!0),a.beginPath(),a.arc(r,l,3.5,0,2*Math.PI),a.fillStyle=g,a.fill();const y=6*p*Math.PI/180-Math.PI/2;a.save(),a.translate(r,l),a.rotate(y),a.beginPath(),a.moveTo(-15,0),a.lineTo(0,0),a.lineWidth=2,a.strokeStyle=f,a.stroke(),a.beginPath(),a.moveTo(0,0),a.lineTo(.9*i,0),a.lineWidth=1.5,a.stroke(),a.beginPath(),a.arc(0,0,2.5,0,2*Math.PI),a.fillStyle=f,a.fill(),a.beginPath(),a.arc(-15,0,2,0,2*Math.PI),a.fillStyle=f,a.fill(),a.restore()}function drawHand(e,t,a,n,s,o,r,l){e.save(),l&&(e.shadowColor="rgba(0,0,0,0.25)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=1),e.beginPath(),e.lineCap="round",e.lineWidth=o,e.strokeStyle=r,e.moveTo(t,a),e.lineTo(t+s*Math.cos(n),a+s*Math.sin(n)),e.stroke(),e.restore()}!function(){const e=document.getElementById("loginOverlay"),t=document.getElementById("loginForm"),a=document.getElementById("loginPassword"),n=document.getElementById("loginBtn"),s=document.getElementById("loginBtnText"),o=(document.querySelector(".login-card"),document.getElementById("loginLock"));function r(){e.classList.add("hidden"),connect()}function l(){e.classList.remove("hidden"),a.focus()}function i(){o.classList.remove("error"),o.offsetWidth,o.classList.add("error")}fetch("/api/auth/check").then(e=>e.json()).then(e=>{e.authenticated?r():l()}).catch(()=>l()),t.addEventListener("submit",function(e){e.preventDefault();const t=a.value;t&&(n.disabled=!0,s.textContent="Verifying...",o.classList.remove("error","success"),a.classList.remove("error"),fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:t})}).then(e=>e.json().then(t=>({status:e.status,data:t}))).then(({status:e,data:t})=>{200===e&&t.ok?(o.classList.add("success"),setTimeout(()=>r(),500)):429===e?(a.classList.add("error"),i()):(a.classList.add("error"),a.value="",a.focus(),i()),n.disabled=!1,s.textContent="Unlock"}).catch(()=>{i(),n.disabled=!1,s.textContent="Unlock"}))}),a.addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),t.dispatchEvent(new Event("submit")))})}(),function(){let e=null,t=null,a=null,n=!1;const s=document.getElementById("termModal"),o=document.getElementById("termScreen"),r=document.getElementById("termFab");function l(){const e=getComputedStyle(document.documentElement),t=e.getPropertyValue("--term-bg").trim()||"#000000",a=e.getPropertyValue("--term-text").trim()||"#ffffff",n=e.getPropertyValue("--accent").trim()||"#0a84ff";return{background:t,foreground:a,cursor:a,cursorAccent:t,selection:n+"40",black:"#000000",red:e.getPropertyValue("--red").trim(),green:e.getPropertyValue("--green").trim(),yellow:e.getPropertyValue("--yellow").trim(),blue:n,magenta:e.getPropertyValue("--purple").trim(),cyan:e.getPropertyValue("--cyan").trim(),white:e.getPropertyValue("--text").trim(),brightBlack:"#808080",brightRed:"#ff453a",brightGreen:"#32d74b",brightYellow:"#ffd60a",brightBlue:"#0a84ff",brightMagenta:"#bf5af2",brightCyan:"#64d2ff",brightWhite:"#ffffff"}}function i(){e&&(e.options.theme=l())}new MutationObserver(e=>{for(const t of e)if("data-theme"===t.attributeName){i();break}}).observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]}),window.openTerminal=function(){n=!0,s.classList.add("show"),e||e||(e=new Terminal({cursorBlink:!0,fontFamily:'Menlo, Monaco, "Courier New", monospace',fontSize:13,lineHeight:1.2,theme:l(),allowTransparency:!0}),t=new FitAddon.FitAddon,e.loadAddon(t),e.open(o),setTimeout(()=>{try{t.fit()}catch(e){}},50),e.onData(e=>{a&&a.readyState===WebSocket.OPEN&&a.send(JSON.stringify({type:"input",data:e}))}),new ResizeObserver(()=>{if(n&&t){try{t.fit()}catch(e){}a&&a.readyState===WebSocket.OPEN&&a.send(JSON.stringify({type:"resize",cols:e.cols,rows:e.rows}))}}).observe(o)),a?requestAnimationFrame(()=>{t.fit(),e.focus(),setTimeout(()=>e.focus(),50),a.readyState===WebSocket.OPEN&&a.send(JSON.stringify({type:"resize",cols:e.cols,rows:e.rows}))}):function(){if(a)return;const o="https:"===location.protocol?"wss:":"ws:";a=new WebSocket(o+"//"+location.host+"/ws/terminal"),a.onopen=()=>{0===e.buffer.active.cursorY&&e.buffer.active.cursorX,e.reset(),e.write("[32mConnected to Talaria Shell[0m\r\n\r\n"),r.classList.add("active"),t.fit(),e.focus(),a.send(JSON.stringify({type:"resize",cols:e.cols,rows:e.rows}))},a.onmessage=t=>{try{const o=JSON.parse(t.data);"output"===o.type?e.write(o.data):"exit"===o.type&&(n=!1,s.classList.remove("show"),a&&(a.close(),a=null),e&&e.reset())}catch(e){}},a.onclose=()=>{r.classList.remove("active"),a=null}}()},window.closeTerminal=function(){n=!1,s.classList.remove("show")},r&&(r.onclick=window.openTerminal),document.addEventListener("keydown",e=>{"`"!==e.key||e.ctrlKey||"INPUT"===document.activeElement.tagName||"TEXTAREA"===document.activeElement.tagName||(e.preventDefault(),n?window.closeTerminal():window.openTerminal())})}();